# Azure AI Search Simulator - Docker Compose
# Run with: docker-compose up -d

services:
  search-simulator:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: azure-ai-search-simulator
    ports:
      - "7250:8443"  # HTTPS (recommended for Azure SDK)
      - "5250:8080"  # HTTP
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=https://+:8443;http://+:8080
      - ASPNETCORE_Kestrel__Certificates__Default__Path=/app/certs/dev-cert.pfx
      - ASPNETCORE_Kestrel__Certificates__Default__Password=dev-password
      - SimulatorSettings__AdminApiKey=admin-key-12345
      - SimulatorSettings__QueryApiKey=query-key-67890
      - SimulatorSettings__DataDirectory=/app/data
      - LuceneSettings__IndexPath=/app/lucene-indexes
      - Serilog__WriteTo__1__Args__path=/app/logs/simulator-.log
      - AzureOpenAISettings__ApiKey=${AZURE_OPENAI_API_KEY:-}
      - LocalEmbeddingSettings__ModelsDirectory=/app/models
    volumes:
      # Persist simulator data (LiteDB) between container restarts
      - simulator-data:/app/data
      # Persist Lucene search indexes
      - lucene-indexes:/app/lucene-indexes
      # Mount logs directory for access from host
      - ./logs:/app/logs
      # Mount local files for indexer file processing (pull mode)
      - ./files:/app/files
      # Mount local test data (optional, read-only)
      - ./testdata:/app/testdata:ro
      # Mount ONNX embedding models (download with scripts/Download-EmbeddingModel.ps1)
      - ./src/AzureAISearchSimulator.Api/data/models:/app/models:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 10s
    restart: unless-stopped
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

volumes:
  simulator-data:
    name: azure-ai-search-simulator-data
  lucene-indexes:
    name: azure-ai-search-simulator-lucene
